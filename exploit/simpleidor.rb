require 'net/http'
require 'uri'
require 'securerandom'

BASE_URL = 'http://localhost:7331'
USERS_COUNT = 10

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–µ—Å—Å–∏—é
def register_user
  username = "user_#{SecureRandom.hex(3)}"
  email = "#{username}@gmail.com"
  password = SecureRandom.hex(12)

  uri = URI("#{BASE_URL}/users/register")
  req = Net::HTTP::Post.new(uri)
  req.set_form_data(
    {
      'username' => username,
      'email' => email,
      'password' => password
    }
  )

  res = Net::HTTP.start(uri.hostname, uri.port) { |http| http.request(req) }

  unless res.code.to_i == 302
    puts "[‚úó] –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ #{email}: #{res.code}"
    exit(1)
  end

  puts "[‚úì] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: #{email}"
  {
    email: email,
    cookies: res['Set-Cookie']
  }
end

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª—è –∏ –ø–∞—Ä—Å–∏–º –±–∞–ª–∞–Ω—Å
def fetch_user_balance(session)
  uri = URI("#{BASE_URL}/users/profile")
  req = Net::HTTP::Get.new(uri)
  req['Cookie'] = session[:cookies]

  res = Net::HTTP.start(uri.hostname, uri.port) { |http| http.request(req) }

  unless res.code.to_i == 200
    puts "[‚úó] –û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è: #{res.code}"
    return 0
  end

  html = res.body
  # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –±–∞–ª–∞–Ω—Å–æ–º ‚Äî –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–¥ –≤–µ—Ä—Å—Ç–∫—É
  if html =~ /id="user-balance">(\d+)</
    balance = Regexp.last_match(1).to_i
    puts "[üí∞] –ë–∞–ª–∞–Ω—Å –¥–ª—è #{session[:email]}: #{balance} –∫—Ä–µ–¥–∏—Ç–æ–≤"
    balance
  else
    puts '[!] –ë–∞–ª–∞–Ω—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ HTML'
    0
  end
end

# –ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥—Ä—É–≥–æ–º—É
def transfer_money(sender:, to_email:, amount:)
  uri = URI("#{BASE_URL}/transactions/transfer")
  req = Net::HTTP::Post.new(uri)
  req['Cookie'] = sender[:cookies]
  req.set_form_data(
    {
      'sender_email' => sender[:email],
      'recipient_email' => to_email,
      'amount' => amount
    }
  )

  res = Net::HTTP.start(uri.hostname, uri.port) { |http| http.request(req) }

  if res.code.to_i == 302
    puts "[‚Üí] #{sender[:email]} –æ—Ç–ø—Ä–∞–≤–∏–ª #{amount} –∫—Ä–µ–¥–∏—Ç–æ–≤ -> #{to_email}"
  else
    puts "[‚úó] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –æ—Ç #{sender[:email]}: #{res.code}"
  end
end

# --- –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ ---

# –®–∞–≥ 1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ—Ö
users = USERS_COUNT.times.map { register_user }

recipient = users.first
senders = users[1..]

# –®–∞–≥ 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª–æ–≤–∏–Ω—É
senders.each do |sender|
  amount = fetch_user_balance(sender)
  next if amount <= 0

  transfer_money(sender: sender, to_email: recipient[:email], amount: amount)
end
