require 'net/http'
require 'uri'
require 'securerandom'

BASE_URL = 'http://localhost:7331'

# Регистрация пользователя и получение cookies
def register_user
  username = "user_#{SecureRandom.hex(8)}"
  email = "user_#{SecureRandom.hex(8)}@gmail.com"
  password = SecureRandom.hex(12)

  uri = URI("#{BASE_URL}/users/register")
  req = Net::HTTP::Post.new(uri)
  req.set_form_data(
    {
      'username' => username,
      'email' => email,
      'password' => password
    }
  )

  res = Net::HTTP.start(uri.hostname, uri.port) do |http|
    http.request(req)
  end

  if res.code.to_i == 302
    puts "[✓] Пользователь зарегистрирован: #{username}, #{email}"
    {
      username: username,
      email: email,
      cookies: res['Set-Cookie']
    }
  else
    puts "[✗] Ошибка регистрации: #{res.code}"
    exit(1)
  end
end

def update_user_session(session)
  100.times do |i| # зависит от размера pool'a подключений
    uri = URI("#{BASE_URL}/users")
    req = Net::HTTP::Post.new(uri)
    req['Cookie'] = session[:cookies]
    req.set_form_data(
      {
        'username' => "#{session[:username]}_#{i}",
        'email' => "#{session[:email].split('@').first}_#{i}@gmail.com"
      }
    )

    res = Net::HTTP.start(uri.hostname, uri.port) do |http|
      http.request(req)
    end

    if res.code.to_i == 302
      puts "[#{i + 1}/200] ✓ Обновление прошло успешно"
    else
      puts "[#{i + 1}/200] ✗ Ошибка обновления: #{res.code}"
    end
  end
end

session = register_user
update_user_session(session)
